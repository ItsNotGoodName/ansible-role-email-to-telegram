- name: install saslauthd and postfix
  package:
    name:
      - postfix
      - sasl2-bin
    state: present

- name: postfix started and enabled
  service:
    name: postfix
    state: started
    enabled: yes

- name: create sasl2 config folder
  file:
    dest: /etc/sasl2
    state: directory

- name: copy smtpd.conf
  copy:
    src: smtpd.conf
    dest: /etc/postfix/sasl/smtpd.conf
  notify: restart postfix

- name: copy main.cf
  copy:
    src: main.cf
    dest: /etc/postfix/main.cf 
  notify: restart postfix

- name: configure saslauthd
  lineinfile:
    path: /etc/default/saslauthd
    regexp: "{{ item.regexp }}"
    line: "{{ item.line}}"
  notify: restart saslauthd
  with_items:
    - { regexp: "^START.*=.*$", line: "START=yes" }
    - { regexp: "^MECHANISMS.*=.*$", line: 'MECHANISMS="shadow"' }

- name: add postfix user to sasl group
  user:
    name: postfix
    groups: sasl
    append: "yes"

- name: copy fix-saslauthd.sh script
  copy:
    src: fix-saslauthd.sh
    dest: /opt/
    mode: "0744"
  notify: restart postfix
  when: ansible_distribution == 'Debian'

- name: run fix-saslauthd script on reboot
  cron:
    name: "fixes saslauthd run directory for debian"
    special_time: reboot
    job: "/opt/fix-saslauthd.sh"
  when: ansible_distribution == 'Debian'

- name: make mail folder writeable
  file:
    dest: /var/mail
    mode: "777"
    state: directory
